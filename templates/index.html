<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lagrangelo web開発チーム — 観光スポット検索デモ（OSM＋カードUI＋口コミ＋お気に入り）</title>

<!-- Fonts（柔らかい丸ゴ） -->
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Leaflet / Cluster -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<link rel="stylesheet" href="{{ url_for('static', filename='style.css')}}">
</head>
<body>

<!-- Nav -->
<div class="nav">
  <div class="nav-inner">
    <div class="brand">
      <span class="badge" aria-hidden="true"></span>
      <span>Lagrangelo web開発チーム</span>
    </div>
    <div class="nav-auth">
      <span class="user-greeting" data-guest>ゲストさん</span>
      <span class="user-greeting" data-member hidden data-user-greeting></span>
      <button id="openAuthModal" class="login" data-guest data-open-auth type="button">ログイン / 新規登録</button>
      <button id="logoutButton" class="login" data-member hidden type="button">ログアウト</button>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="auth-modal" hidden>
  <div class="auth-modal__overlay" data-close></div>
  <div class="auth-modal__body" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
    <button type="button" class="auth-modal__close" data-close aria-label="閉じる">×</button>
    <h2 id="authModalTitle">ログイン / 新規登録</h2>
    <div class="auth-modal__tabs" role="tablist">
      <button type="button" class="auth-modal__tab is-active" data-auth-tab="login" role="tab">ログイン</button>
      <button type="button" class="auth-modal__tab" data-auth-tab="signup" role="tab">新規登録</button>
    </div>
    <form id="loginForm" class="auth-modal__form" autocomplete="on">
      <label class="auth-modal__label">メールアドレス
        <input type="email" name="email" required autocomplete="email" />
      </label>
      <label class="auth-modal__label">パスワード
        <input type="password" name="password" required autocomplete="current-password" minlength="6" />
      </label>
      <button type="submit" class="btn primary auth-modal__submit">ログイン</button>
    </form>
    <form id="signupForm" class="auth-modal__form" hidden autocomplete="on">
      <label class="auth-modal__label">お名前（マイページに表示されます）
        <input type="text" name="displayName" required maxlength="40" />
      </label>
      <label class="auth-modal__label">メールアドレス
        <input type="email" name="email" required autocomplete="email" />
      </label>
      <label class="auth-modal__label">パスワード（6文字以上）
        <input type="password" name="password" required autocomplete="new-password" minlength="6" />
      </label>
      <button type="submit" class="btn primary auth-modal__submit">新規登録</button>
    </form>
  </div>
</div>

<!-- Auth Switcher -->
<section class="auth-section" data-guest>
  <div class="wrap" style="padding-top:12px;">
    <div class="auth-card">
      <h2 style="margin:0">ゲスト向けコンテンツ</h2>
      <p style="margin:4px 0 12px; color:#475569;">ログインすると会員機能（お気に入り・コメント・検索履歴）が使えます。</p>
      <button type="button" class="btn primary" style="justify-content:center" data-open-auth>ログイン / 新規登録</button>
    </div>
  </div>
</section>

<section class="auth-section" data-member hidden>
  <div class="wrap" style="padding-top:12px;">
    <div class="auth-card">
      <h2 style="margin:0">会員向けコンテンツ</h2>
      <p style="margin:4px 0 12px; color:#475569;">Firebaseで認証された会員さま向けの情報です。</p>
      <pre id="member-content" style="margin:0; white-space:pre-wrap; background:#f1f5f9; padding:12px; border-radius:12px; font-size:13px; max-height:180px; overflow:auto;"></pre>
      
    </div>
  </div>
</section>

<!-- Hero -->
<section class="hero">
  <div class="hero-inner">
    <h1>旅の「いいね」を地図で集める。</h1>
    <p>雑誌のように眺めて、地図で絞り込む。地方→都道府県→市の絞り込み、地図タップの半径検索＆Shift+ドラッグの四角選択、タグでの発見、さらに場所ごとの口コミと★評価まで、ワンページで完結。</p>
  </div>
</section>

<!-- Search & controls -->
<div class="wrap">
  <div class="search-card">
    <div class="search-top">
      <div class="search-wrap">
        <form id="searchForm" class="search-bar" novalidate>
          <input id="q" type="search" inputmode="search" placeholder="キーワード（未入力でもOK：地域/タグ/範囲で絞込）">
          <button>検索</button>
        </form>
      </div>

      <div class="geo-cascade">
        <select id="regionSelect" aria-label="地方">
          <option value="">地方（未選択）</option>
          
        </select>
        <select id="prefSelect" aria-label="都道府県" disabled>
          <option value="">都道府県（まず地方を選択）</option>
        </select>
        <select id="citySelect" aria-label="市区町村" disabled>
          <option value="">市区町村（まず都道府県を選択）</option>
        </select>
        <button id="clearGeo" class="btn ghost" type="button">× 地域クリア</button>
      </div>

      <!-- タグフィルタ（自動生成） -->
      <div class="tagbar" id="tagBar" aria-label="タグで絞り込み"></div>
      <div style="text-align:center; margin:-4px 0 4px;">
        <button id="clearTags" class="btn ghost" type="button">タグ解除</button>
      </div>
    </div>

    <div class="filters">
      <label><input type="checkbox" id="onlyFavs"> お気に入りのみ</label>
      
      <label><input type="checkbox" id="onlyDiscount"> 学割ありのみ</label>
      <label><input type="checkbox" id="boundsOnly"> 表示範囲だけ</label>
      <label><input type="checkbox" id="sortByDistance"> 距離順（現在地）</label>
      <button id="locateBtn" class="btn" type="button">◎ 現在地</button>
      <button id="resetBtn" class="btn" type="button">↺ リセット</button>
      <small id="geoStatus" class="muted"></small>
      <small id="favCounter" class="muted"></small>
    </div>
    <div class="search-history-card" data-member hidden>
      <h3>最近の検索</h3>
      <div id="searchHistoryList" class="search-history-list" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- Main -->
<main class="wrap" style="padding-top:0">
  <section class="layout">
    <div class="panel">
      <h2>スポット <span id="resultCount" class="muted"></span></h2>
      <div class="list" id="list"></div>
    </div>

    <div class="panel">
      <h2 style="margin:0; padding:12px 14px;">地図（タップ＝円 / Shift+ドラッグ＝四角）</h2>
      <div id="map" aria-label="地図"></div>
      <div class="mapbar">
        <div class="radiusWrap">
          <span class="muted">半径</span>
          <input id="radius" type="range" min="100" max="3000" step="50" value="600">
          <span id="radiusVal" class="muted">600m</span>
        </div>
        <div class="pills" aria-label="半径プリセット">
          <button class="pill" data-r="300">300m</button>
          <button class="pill active" data-r="600">600m</button>
          <button class="pill" data-r="1000">1km</button>
          <button class="pill" data-r="2000">2km</button>
        </div>
        <button id="centerHere" class="btn" type="button">⊙ 中心＝現在地</button>
        <span id="stat" class="muted">選択範囲：なし（地図をタップ / Shift+ドラッグ）</span>
      </div>
    </div>
  </section>
</main>

<footer>© 2025 Lagrangelo web開発チーム · タイル: © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a></footer>

<!-- Slide-in Detail Panel -->
<div id="slidePanel" class="panel-detail" aria-live="polite">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <h3 id="panelTitle" style="margin:0">詳細</h3>
     <div style="display:flex;gap:8px;align-items:center">
      <button id="favInPanel" class="btn fav-btn" type="button">♡ お気に入り</button>
      <button id="closePanel" class="closeBtn" type="button">閉じる</button>
    </div>
  </div>
  <div id="panelContent" class="content"></div>
  <div class="actions">
    <a id="panelLink" class="btn primary" target="_blank" rel="noopener" href="#">公式/学割ページへ</a>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Scripts -->
<script type="module" src="{{ url_for('static', filename='js/firebase-auth.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="{{url_for('static', filename='index.js')}}"></script>
<script>
  (() => {
    const authModal = document.getElementById('authModal');
    if (!authModal) {
      return;
    }
     const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const logoutButton = document.getElementById('logoutButton');
    const tabButtons = Array.from(authModal.querySelectorAll('[data-auth-tab]'));
    const openButtons = Array.from(document.querySelectorAll('[data-open-auth]'));

    let currentMode = 'login';

    const loadFirebaseModule = (() => {
      let cache = null;
      return async () => {
        if (!cache) {
          cache = await import('{{ url_for('static', filename='js/firebase-auth.js') }}');
        }
        return cache;
      };
    })();

    const setMode = (mode) => {
      currentMode = mode === 'signup' ? 'signup' : 'login';
      if (loginForm) {
        loginForm.hidden = currentMode !== 'login';
      }
      if (signupForm) {
        signupForm.hidden = currentMode !== 'signup';
      }
      tabButtons.forEach((btn) => {
        btn.classList.toggle('is-active', btn.dataset.authTab === currentMode);
      });
    };

    const focusInitialField = () => {
      if (currentMode === 'login') {
        loginForm?.querySelector('input[name="email"]')?.focus();
      } else {
        signupForm?.querySelector('input[name="displayName"]')?.focus();
      }
    };

    const openModal = (mode = 'login') => {
      setMode(mode);
      authModal.hidden = false;
      document.body.classList.add('modal-open');
      focusInitialField();
    };

    const closeModal = () => {
      authModal.hidden = true;
      document.body.classList.remove('modal-open');
      loginForm?.reset();
      signupForm?.reset();
      setMode('login');
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        setMode(btn.dataset.authTab === 'signup' ? 'signup' : 'login');
        focusInitialField();
      });
    });

    openButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.authMode === 'signup' ? 'signup' : 'login';
        openModal(mode);
      });
    });

    authModal.addEventListener('click', (event) => {
      const target = event.target;
      if (target instanceof Element && target.closest('[data-close]')) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !authModal.hidden) {
        closeModal();
      }
    });

    loginForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.currentTarget;
      const email = form.email?.value?.trim();
      const password = form.password?.value || '';
      if (!email || !password) {
        alert('メールアドレスとパスワードを入力してください。');
        return;
      }
      try {
        const mod = await loadFirebaseModule();
        await mod.doLogin(email, password);
      } catch (error) {
        console.error(error);
        alert('ログインに失敗しました。入力内容をご確認ください。');
      }
    });

    signupForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.currentTarget;
      const displayName = form.displayName?.value?.trim();
      const email = form.email?.value?.trim();
      const password = form.password?.value || '';
      if (!displayName || !email || !password) {
        alert('お名前・メールアドレス・パスワードを入力してください。');
        return;
      }
      try {
        const mod = await loadFirebaseModule();
        await mod.doSignup(email, password, displayName);
        alert('会員登録が完了しました。引き続きログイン状態でご利用いただけます。');
      } catch (error) {
        console.error(error);
        alert('新規登録に失敗しました。入力内容をご確認ください。');
      }
    });

    logoutButton?.addEventListener('click', async () => {
      try {
        const mod = await loadFirebaseModule();
        await mod.doLogout();
      } catch (error) {
        console.error(error);
      }
    });

    window.addEventListener('firebase-auth-state', (event) => {
      const detail = event.detail || {};
      if (detail.user) {
        closeModal();
      } else {
        setMode('login');
      }
    });
  })();
</script>
</body>
</html>
